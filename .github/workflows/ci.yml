name: Universal CI (Python + Java + JS/TS)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: |
            **/package-lock.json
            **/npm-shrinkwrap.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Python CI
        shell: bash
        run: |
          set -e
          if find . -type f -name "*.py" -not -path "./.venv/*" -not -path "./venv/*" | grep -q .; then
            echo "Python project detected."
            python -m pip install --upgrade pip

            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi

            if [ -f pyproject.toml ]; then
              pip install .
            elif [ -f setup.py ]; then
              pip install .
            fi

            pip install pytest

            if find . -type f \( -name "test_*.py" -o -name "*_test.py" \) | grep -q .; then
              pytest -q
            else
              echo "No pytest test files found. Running import/syntax check."
              python -m compileall -q .
            fi
          else
            echo "No Python files found. Skipping Python CI."
          fi

      - name: Java CI
        shell: bash
        run: |
          set -e
          if [ -f pom.xml ]; then
            echo "Maven project detected."
            mvn -B -ntp test
          elif [ -f ./gradlew ]; then
            echo "Gradle wrapper project detected."
            chmod +x ./gradlew
            ./gradlew test --no-daemon
          elif [ -f build.gradle ] || [ -f build.gradle.kts ]; then
            echo "Gradle build file found but no wrapper. Skipping to avoid environment mismatch."
            echo "Recommendation: add gradlew/gradlew.bat to repository."
          else
            echo "No Java build file found. Skipping Java CI."
          fi

      - name: JavaScript / TypeScript CI
        shell: bash
        run: |
          set -e
          if [ -f package.json ]; then
            echo "Node project detected."
            corepack enable || true

            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              npm ci
              RUNNER="npm run -s"
            elif [ -f pnpm-lock.yaml ]; then
              corepack prepare pnpm@latest --activate
              pnpm install --frozen-lockfile
              RUNNER="pnpm run"
            elif [ -f yarn.lock ]; then
              corepack prepare yarn@stable --activate
              yarn install --frozen-lockfile
              RUNNER="yarn run"
            else
              npm install
              RUNNER="npm run -s"
            fi

            has_script () {
              node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts['$1'] ? 0 : 1)"
            }

            if has_script lint; then $RUNNER lint; else echo "No lint script"; fi
            if has_script typecheck; then $RUNNER typecheck; else echo "No typecheck script"; fi
            if has_script test; then $RUNNER test; else echo "No test script"; fi
            if has_script build; then $RUNNER build; else echo "No build script"; fi
          else
            echo "No package.json found. Skipping JS/TS CI."
          fi
