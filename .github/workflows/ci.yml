name: Universal CI (Lenient)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Python checks
        shell: bash
        run: |
          set +e
          if find . -type f -name "*.py" -not -path "./.venv/*" -not -path "./venv/*" | grep -q .; then
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            pip install pytest
            if find . -type f \( -name "test_*.py" -o -name "*_test.py" \) | grep -q .; then
              pytest -q || echo "pytest failed (non-blocking in lenient mode)"
            else
              python -m compileall -q . || echo "python compile check failed (non-blocking)"
            fi
          else
            echo "No Python files found"
          fi
          exit 0

      - name: Java checks
        shell: bash
        run: |
          set +e
          if [ -f pom.xml ]; then
            mvn -B -ntp test || echo "maven test failed (non-blocking)"
          elif [ -f ./gradlew ]; then
            chmod +x ./gradlew
            ./gradlew test --no-daemon || echo "gradle test failed (non-blocking)"
          elif [ -f build.gradle ] || [ -f build.gradle.kts ]; then
            echo "Gradle file found without wrapper; skipping"
          else
            echo "No Java build config found"
          fi
          exit 0

      - name: JavaScript/TypeScript checks
        shell: bash
        run: |
          set +e
          if [ -f package.json ]; then
            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              npm ci || npm install
            else
              npm install
            fi

            has_script () {
              node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts['$1'] ? 0 : 1)"
            }

            if has_script test; then npm run -s test || echo "test failed (non-blocking)"; else echo "No test script"; fi
            if has_script build; then npm run -s build || echo "build failed (non-blocking)"; else echo "No build script"; fi
          else
            echo "No package.json found"
          fi
          exit 0
